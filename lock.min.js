/* Anime Lock System v3 - jsDelivr Ready */
(function(){
let unlocked=[],uid=null,unsub=null;
const q=s=>document.querySelector(s);
const listSel=".epi-list";

function apply(){
const box=q(listSel); if(!box)return;
box.querySelectorAll(".item").forEach((it,i)=>{
const ep=episodes[i]; if(!ep)return;
const id=streamingId+"-eps-"+ep.episode;
const unlock=(!ep.price||unlocked.includes(id));
it.classList.toggle("ep-locked",!unlock);
it.dataset.epid=id; it.dataset.price=ep.price||0; it.dataset.index=i;
});
}

function showBuy(t,fn){
q("#buyText").innerHTML=t;
q("#buyBox").style.display="flex";
q("#buyYes").onclick=fn;
}
function hideBuy(){ q("#buyBox").style.display="none"; }

function handler(){
const box=q(listSel); if(!box)return;
const clone=box.cloneNode(true);
box.parentNode.replaceChild(clone,box);

clone.addEventListener("click",ev=>{
const btn=ev.target.closest(".item,.btn-ep,a"); if(!btn)return;
ev.preventDefault();
const it=btn.closest(".item"); if(!it)return;
const idx=+it.dataset.index,ep=episodes[idx];
const id=it.dataset.epid,price=+it.dataset.price;
const unlockedNow=!price||unlocked.includes(id);

if(unlockedNow){
location.href="?ep="+ep.episode; return;
}

if(!auth.currentUser){ alert("Silakan login terlebih dahulu."); return;}

showBuy(`Beli <b>Episode ${ep.episode}</b> seharga <b>${price} coin</b>?`,async()=>{
try{
const ok=await unlockEpisodeUnique(id,price,{
title:(q(".post-title")?.innerText||""),
episode:ep.episode,
thumb:(q(".anime-thumbnail img")?.src||"")
});
if(ok){
if(!unlocked.includes(id))unlocked.push(id);
apply(); hideBuy();
location.href="?ep="+ep.episode;
}else alert("Pembelian gagal.");
}catch(e){console.error(e);alert("Error membeli.");}
});
},{passive:false});
}

function authWatch(){
auth.onAuthStateChanged(async u=>{
if(unsub){try{unsub();}catch(e){} unsub=null;}
if(!u){ unlocked=[]; uid=null; apply(); return; }
uid=u.uid;
const snap=await db.collection("users").doc(uid).get();
unlocked=snap.exists?(snap.data().unlocked||[]):[];
apply();
unsub=db.collection("users").doc(uid).onSnapshot(d=>{
unlocked=d.exists?(d.data().unlocked||[]):[];
apply();
});
});
}

function waitList(){
return new Promise(r=>{
if(q(listSel)&&q(listSel).querySelector(".item"))return r(q(listSel));
const mo=new MutationObserver(()=>{
if(q(listSel)&&q(listSel).querySelector(".item")){
mo.disconnect(); r(q(listSel));
}
});
mo.observe(document.body,{childList:true,subtree:true});
setTimeout(()=>{mo.disconnect(); r(q(listSel));},8000);
});
}

document.addEventListener("DOMContentLoaded",async()=>{
if(!episodes||!Array.isArray(episodes))return;
episodes.forEach(ep=>ep.price=Number(ep.price)||0);
q("#buyCancel")?.addEventListener("click",hideBuy);
await waitList();
apply(); handler(); authWatch();
});
})();
